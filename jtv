// Stalker-Portal To M3U Generator Script
// Fixed & Optimized
// This script is free for everyone to use

// ============ âš™ CONFIGURATION (EDIT THIS) ============
const config = {
    host: '',           // e.g. 'portal.example.com' (Do not include http://)
    mac_address: '',    // e.g. '00:1A:79:XX:XX:XX'
    serial_number: '',  // Your STB Serial Number
    device_id: '',      // Device ID 1
    device_id_2: '',    // Device ID 2
    stb_type: 'MAG250', // Usually MAG250 or similar
    api_signature: '263', // Keep as is usually
};

// ============ ðŸ›  HELPER FUNCTIONS ============

// Auto-generate hw_version & hw_version_2 based on MAC/Serial
async function generateHardwareVersions() {
    config.hw_version = '1.7-BD-' + (await hash(config.mac_address)).substring(0, 2).toUpperCase();
    config.hw_version_2 = await hash(config.serial_number.toLowerCase() + config.mac_address.toLowerCase());
}

async function hash(str) {
    const data = new TextEncoder().encode(str);
    const digest = await crypto.subtle.digest('MD5', data);
    return Array.from(new Uint8Array(digest)).map(x => x.toString(16).padStart(2, '0')).join('');
}

function logDebug(message) {
    // Logs to Cloudflare dashboard ("Logs" tab)
    console.log(`${new Date().toISOString()} - ${message}`);
}

function getHeaders(token = '') {
    const headers = {
        'Cookie': `mac=${config.mac_address}; stb_lang=en; timezone=GMT`,
        'Referer': `http://${config.host}/stalker_portal/c/`,
        'User-Agent': 'Mozilla/5.0 (QtEmbedded; U; Linux; C) AppleWebKit/533.3 (KHTML, like Gecko) MAG200 stbapp ver: 2 rev: 250 Safari/533.3',
        'X-User-Agent': `Model: ${config.stb_type}; Link: WiFi`
    };
    if (token) {
        headers['Authorization'] = `Bearer ${token}`;
    }
    return headers;
}

// ============ ðŸ”„ AUTHENTICATION LOGIC ============

async function getToken() {
    const url = `http://${config.host}/stalker_portal/server/load.php?type=stb&action=handshake&token=&JsHttpRequest=1-xml`;
    try {
        const response = await fetch(url, { headers: getHeaders() });
        if (!response.ok) return '';
        const text = await response.text();
        const data = JSON.parse(text);
        return data.js?.token || '';
    } catch (e) {
        logDebug(`Error in getToken: ${e.message}`);
        return '';
    }
}

async function auth(token) {
    const metrics = { mac: config.mac_address, model: '', type: 'STB', uid: '', device: '', random: '' };
    const metricsEncoded = encodeURIComponent(JSON.stringify(metrics));

    const url = `http://${config.host}/stalker_portal/server/load.php?type=stb&action=get_profile`
        + `&hd=1&ver=ImageDescription:%200.2.18-r14-pub-250;`
        + `%20PORTAL%20version:%205.5.0;%20API%20Version:%20328;`
        + `&num_banks=2&sn=${config.serial_number}`
        + `&stb_type=${config.stb_type}&client_type=STB&image_version=218&video_out=hdmi`
        + `&device_id=${config.device_id}&device_id2=${config.device_id_2}`
        + `&signature=&auth_second_step=1&hw_version=${config.hw_version}`
        + `&not_valid_token=0&metrics=${metricsEncoded}`
        + `&hw_version_2=${config.hw_version_2}&api_signature=${config.api_signature}`
        + `&prehash=&JsHttpRequest=1-xml`;

    try {
        const response = await fetch(url, { headers: getHeaders(token) });
        if (!response.ok) return [];
        const text = await response.text();
        const data = JSON.parse(text);
        return data.js || [];
    } catch (e) {
        logDebug(`Error in auth: ${e.message}`);
        return [];
    }
}

async function handShake(token) {
    const url = `http://${config.host}/stalker_portal/server/load.php?type=stb&action=handshake&token=${token}&JsHttpRequest=1-xml`;
    try {
        const response = await fetch(url, { headers: getHeaders() });
        if (!response.ok) return '';
        const text = await response.text();
        const data = JSON.parse(text);
        return data.js?.token || '';
    } catch (e) {
        logDebug(`Error in handShake: ${e.message}`);
        return '';
    }
}

async function getAccountInfo(token) {
    const url = `http://${config.host}/stalker_portal/server/load.php?type=account_info&action=get_main_info&JsHttpRequest=1-xml`;
    try {
        const response = await fetch(url, { headers: getHeaders(token) });
        if (!response.ok) return [];
        const text = await response.text();
        const data = JSON.parse(text);
        return data.js || [];
    } catch (e) {
        logDebug(`Error in getAccountInfo: ${e.message}`);
        return [];
    }
}

async function genToken() {
    await generateHardwareVersions();
    const token = await getToken();
    if (!token) return { token: '', profile: [], account_info: [] };
    
    const profile = await auth(token);
    const newToken = await handShake(token);
    
    if (!newToken) return { token: '', profile, account_info: [] };
    
    const account_info = await getAccountInfo(newToken);
    return { token: newToken, profile, account_info };
}

// ============ ðŸ“º CONTENT FETCHING ============

async function getGenres(token) {
    const url = `http://${config.host}/stalker_portal/server/load.php?type=itv&action=get_genres&JsHttpRequest=1-xml`;
    try {
        const response = await fetch(url, { headers: getHeaders(token) });
        if (!response.ok) return [];
        const text = await response.text();
        const data = JSON.parse(text);
        return data.js || [];
    } catch (e) {
        logDebug(`Error in getGenres: ${e.message}`);
        return [];
    }
}

async function getStreamURL(id, token) {
    // This requests the actual stream link (ffmpeg/http) from the portal
    const url = `http://${config.host}/stalker_portal/server/load.php?type=itv&action=create_link&cmd=ffrt%20http://localhost/ch/${id}&JsHttpRequest=1-xml`;
    try {
        const response = await fetch(url, { headers: getHeaders(token) });
        if (!response.ok) return '';
        const text = await response.text();
        const data = JSON.parse(text);
        return data.js?.cmd || '';
    } catch (e) {
        logDebug(`Error in getStreamURL: ${e.message}`);
        return '';
    }
}

// ============ ðŸ“ M3U GENERATION ============

async function convertJsonToM3U(channels, profile, account_info, request) {
    let m3u = [
        '#EXTM3U',
        `# Total Channels => ${channels.length}`,
        '# Script => Stalker Middleware',
        ''
    ];

    const origin = new URL(request.url).origin;

    // --- Info / Header Items ---
    let server_ip = profile.ip || 'Unknown';
    m3u.push(`#EXTINF:-1 tvg-name="IP" tvg-logo="https://img.icons8.com/?size=160&id=OWj5Eo00EaDP&format=png" group-title="Portal | Info",IP â€¢ ${server_ip}`);
    m3u.push('http://localhost/intro.m3u8'); // Placeholder link

    const created = profile.created || 'Unknown';
    const end_date = account_info.end_date || 'Unknown';
    
    m3u.push(`#EXTINF:-1 tvg-name="Portal" tvg-logo="https://upload.wikimedia.org/wikipedia/commons/6/6f/IPTV.png" group-title="Portal | Info",Portal â€¢ ${config.host}`);
    m3u.push('http://localhost/intro.m3u8');

    m3u.push(`#EXTINF:-1 tvg-name="Expire" tvg-logo="https://cdn-icons-png.flaticon.com/128/1048/1048953.png" group-title="Portal | Info",End date â€¢ ${end_date}`);
    m3u.push('http://localhost/intro.m3u8');

    // --- Process Main Channels ---
    if (!channels.length) {
        logDebug('No channels found to convert');
    } else {
        channels.forEach((channel) => {
            let cmd = channel.cmd || '';
            // Extract the ID: 'ffrt http://localhost/ch/123' -> '123'
            let real_cmd = cmd.replace('ffrt http://localhost/ch/', '');
            
            if (real_cmd && real_cmd !== cmd) {
                const logo_url = channel.logo ? `http://${config.host}/stalker_portal/misc/logos/320/${channel.logo}` : '';
                m3u.push(`#EXTINF:-1 tvg-id="${channel.tvgid}" tvg-name="${channel.name}" tvg-logo="${logo_url}" group-title="${channel.title}",${channel.name}`);
                
                // Create a link to OUR worker: https://worker-url.com/123.m3u8
                const channel_stream_url = `${origin}/${real_cmd}.m3u8`;
                m3u.push(channel_stream_url);
            }
        });
    }

    // --- Custom Sections (Preserved from your script) ---
    const customDRM = `
# ===== CUSTOM DRM MOVIE CHANNELS â­ =====
#KODIPROP:inputstreamaddon=inputstream.adaptive
#KODIPROP:inputstream.adaptive.manifest_type=dash
#KODIPROP:inputstream.adaptive.license_type=org.w3.clearkey
#KODIPROP:inputstream.adaptive.license_key=40f019b86241d23ef075633fd7f1e927:058dec845bd340178a388edd104a015e
#EXTINF:-1 tvg-id="ts210" group-title="Moviesâ­",MN+ HDâ­
https://times-ott-live.akamaized.net/mnplus_wv_drm/index.mpd

#KODIPROP:inputstreamaddon=inputstream.adaptive
#KODIPROP:inputstream.adaptive.manifest_type=dash
#KODIPROP:inputstream.adaptive.license_type=org.w3.clearkey
#KODIPROP:inputstream.adaptive.license_key=40f019b86241d23ef075633fd7f1e927:058dec845bd340178a388edd104a015e
#EXTINF:-1 tvg-id="ts599" group-title="Moviesâ­",MNX HDâ­
https://times-ott-live.akamaized.net/mnxhd_wv_drm/index.mpd

#KODIPROP:inputstreamaddon=inputstream.adaptive
#KODIPROP:inputstream.adaptive.manifest_type=dash
#KODIPROP:inputstream.adaptive.license_type=org.w3.clearkey
#KODIPROP:inputstream.adaptive.license_key=40f019b86241d23ef075633fd7f1e927:058dec845bd340178a388edd104a015e
#EXTINF:-1 tvg-id="ts173" group-title="Moviesâ­",Movies Now HDâ­
https://times-ott-live.akamaized.net/moviesnow_wv_drm/index.mpd
`;
    m3u.push(customDRM);

    // --- Fetch External JTV/JSTAR (Preserved) ---
    try {
        const jtvUrl = "https://long-unit.abhay258.workers.dev/jstar.m3u";
        const jresp = await fetch(jtvUrl, { headers: { "User-Agent": "Mozilla/5.0" }, cf: { colocationOverride: "SJC" } });
        if (jresp && jresp.ok) {
            const jtxt = (await jresp.text()).trim();
            if (jtxt) {
                m3u.push("\n# ===== JTV + JSTAR BLOCK â­ =====");
                m3u.push(jtxt);
            }
        }
    } catch (e) {
        logDebug(`Error fetching JTV: ${e.message}`);
    }

    let out = m3u.join('\n');

    // --- Group Title Cleanup ---
    out = out
      .replace(/group-title="JioTV"/gi, 'group-title="jioâ­"')
      .replace(/group-title="Kids"/gi, 'group-title="Kidsâ­"')
      .replace(/group-title="Movies"/gi, 'group-title="Moviesâ­"')
      .replace(/group-title="Music"/gi, 'group-title="Musicâ­"')
      .replace(/group-title="News"/gi, 'group-title="Newsâ­"')
      .replace(/group-title="Sports"/gi, 'group-title="Sportsâ­"')
      .replace(/group-title="Hindi"/gi, 'group-title="Hindiâ­"')
      .replace(/group-title="Other"/gi, 'group-title="Otherâ­"');

    return out;
}

// ============ ðŸš€ MAIN REQUEST HANDLER ============

addEventListener('fetch', event => {
    event.respondWith(handleRequest(event.request));
});

async function handleRequest(request) {
    const url = new URL(request.url);
    const pathParts = url.pathname.split('/');
    const lastPart = pathParts[pathParts.length - 1];

    try {
        // 1. Generate Token & Auth
        logDebug('Starting auth process...');
        const { token, profile, account_info } = await genToken();
        
        if (!token) {
            return new Response('Stalker Authentication Failed. Check your Host/MAC/Serial in the script config.', { status: 500 });
        }

        // 2. Handle Playlist Request (/playlist.m3u8)
        if (url.pathname === '/playlist.m3u8') {
            // Fetch all channels
            const channelsUrl = `http://${config.host}/stalker_portal/server/load.php?type=itv&action=get_all_channels&JsHttpRequest=1-xml`;
            let channelsData;
            
            try {
                const response = await fetch(channelsUrl, { headers: getHeaders(token) });
                if (!response.ok) throw new Error(`Status ${response.status}`);
                const text = await response.text();
                channelsData = JSON.parse(text);
            } catch (e) {
                return new Response(`Error fetching channels from portal: ${e.message}`, { status: 500 });
            }

            // Fetch genres
            const genres = await getGenres(token);

            // Process Channels
            let channels = [];
            if (channelsData.js?.data) {
                channels = channelsData.js.data.map((item) => ({
                    name: item.name || 'Unknown',
                    cmd: item.cmd || '',
                    tvgid: item.xmltv_id || '',
                    id: item.tv_genre_id || '',
                    logo: item.logo || ''
                }));
            }

            // Map genres
            const groupTitleMap = {};
            genres.forEach(group => { groupTitleMap[group.id] = group.title || 'Other'; });

            channels = channels.map(channel => ({
                ...channel,
                title: groupTitleMap[channel.id] || 'Other'
            }));

            // Generate M3U
            const m3uContent = await convertJsonToM3U(channels, profile, account_info, request);
            
            return new Response(m3uContent, {
                headers: {
                    'Content-Type': 'application/vnd.apple.mpegurl',
                    'Access-Control-Allow-Origin': '*'
                }
            });
        }

        // 3. Handle Individual Stream Request (e.g. /123.m3u8)
        if (lastPart.endsWith('.m3u8') && lastPart !== 'playlist.m3u8') {
            const cmdId = lastPart.replace('.m3u8', ''); 
            logDebug(`Requesting stream for ID: ${cmdId}`);
            
            // Ask the portal for the real URL
            const streamUrl = await getStreamURL(cmdId, token);

            if (streamUrl) {
                // Redirect the player to the real stream
                return Response.redirect(streamUrl, 302);
            } else {
                return new Response('Stream URL expired or not found on portal.', { status: 404 });
            }
        }

        // 4. Default Endpoint
        return new Response('Worker is Running. Visit /playlist.m3u8 to get your playlist.', { status: 200 });

    } catch (e) {
        logDebug(`Critical Worker Error: ${e.message}`);
        return new Response(`Worker Error: ${e.message}`, { status: 500 });
    }
}
