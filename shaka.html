<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Shaka IPTV Player + EPG</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shaka-player@latest/dist/controls.css">
  <script defer src="https://cdn.jsdelivr.net/npm/shaka-player@latest/dist/shaka-player.ui.js"></script>

  <style>
    html, body { height:100%; margin:0; background:#0b0f1a; color:#e6eaf2; font-family:sans-serif; }
    .wrap { display:grid; place-items:center; height:100%; padding:10px; }
    .player-shell { width:min(100%,1200px); aspect-ratio:16/9; background:#111827; border-radius:12px; overflow:hidden; position:relative; }
    .topbar { position:absolute; top:8px; left:8px; right:8px; display:flex; flex-direction:column; gap:6px; z-index:10; background:rgba(17,24,39,.75); padding:8px; border-radius:8px; backdrop-filter:blur(4px); font-size:13px; }
    select { background:#1f2937; color:#fff; border:none; padding:4px 8px; border-radius:6px; }
    .epg { font-size:12px; margin-top:4px; line-height:1.3; color:#d1d5db; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="player-shell">
      <video id="video" class="shaka-video" autoplay muted playsinline></video>
      <div class="topbar">
        <label>Channel: <select id="channelSelect"></select></label>
        <div id="epgBox" class="epg"></div>
      </div>
    </div>
  </div>

  <script>
    function qsParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    const video = document.getElementById('video');
    const channelSelect = document.getElementById('channelSelect');
    const epgBox = document.getElementById('epgBox');
    let player, epgData = {}, currentChannelName = "";

    document.addEventListener('shaka-ui-loaded', initApp);

    async function initApp() {
      await shaka.polyfill.installAll();

      player = new shaka.Player(video);
      new shaka.ui.Overlay(player, document.querySelector('.player-shell'), video);

      const src = qsParam('src');
      const playlistUrl = qsParam('playlist');
      const epgUrl = qsParam('epg'); // XMLTV file

      if (epgUrl) {
        await loadEPG(epgUrl);
        setInterval(() => showEPG(currentChannelName), 60_000); // refresh every 60s
      }

      if (playlistUrl) {
        const channels = await loadPlaylist(playlistUrl);
        buildChannelSelector(channels);
        if (channels.length) {
          currentChannelName = channels[0].name;
          player.load(channels[0].url);
          showEPG(currentChannelName);
        }
      } else if (src) {
        currentChannelName = "Stream";
        await player.load(src);
        showEPG(currentChannelName);
      } else {
        currentChannelName = "Demo";
        await player.load("https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8");
        showEPG(currentChannelName);
      }
    }

    async function loadPlaylist(url) {
      const res = await fetch(url);
      const text = await res.text();
      const lines = text.split("\n");
      const channels = [];
      let name = "Channel";
      for (let line of lines) {
        line = line.trim();
        if (line.startsWith("#EXTINF")) {
          const match = line.match(/,(.*)$/);
          if (match) name = match[1];
        } else if (line && !line.startsWith("#")) {
          channels.push({ name, url: line });
        }
      }
      return channels;
    }

    function buildChannelSelector(channels) {
      channelSelect.innerHTML = "";
      channels.forEach((c, i) => {
        const opt = document.createElement("option");
        opt.value = c.url;
        opt.textContent = c.name || `Channel ${i+1}`;
        channelSelect.appendChild(opt);
      });
      channelSelect.onchange = () => {
        currentChannelName = channelSelect.options[channelSelect.selectedIndex].textContent;
        player.load(channelSelect.value);
        showEPG(currentChannelName);
      };
    }

    async function loadEPG(url) {
      try {
        const res = await fetch(url);
        const xml = new DOMParser().parseFromString(await res.text(), "text/xml");
        const progs = xml.querySelectorAll("programme");
        epgData = {};
        progs.forEach(p => {
          const channel = p.getAttribute("channel");
          const start = parseTime(p.getAttribute("start"));
          const stop = parseTime(p.getAttribute("stop"));
          const title = p.querySelector("title")?.textContent || "Untitled";
          if (!epgData[channel]) epgData[channel] = [];
          epgData[channel].push({ start, stop, title });
        });
      } catch (e) {
        console.error("EPG load failed", e);
      }
    }

    function parseTime(str) {
      const m = str.match(/^(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/);
      if (!m) return null;
      return new Date(`${m[1]}-${m[2]}-${m[3]}T${m[4]}:${m[5]}:${m[6]}Z`);
    }

    function showEPG(channelName) {
      if (!channelName || !Object.keys(epgData).length) {
        epgBox.textContent = "";
        return;
      }
      const chanKey = Object.keys(epgData).find(k =>
        k.toLowerCase().includes(channelName.toLowerCase())
      );
      if (!chanKey) {
        epgBox.textContent = "";
        return;
      }
      const now = new Date();
      const current = epgData[chanKey].find(p => p.start <= now && p.stop > now);
      const next = epgData[chanKey].find(p => p.start > now);
      epgBox.innerHTML = `
        <div><strong>Now:</strong> ${current ? current.title : "No data"}</div>
        <div><strong>Next:</strong> ${next ? next.title : "No data"}</div>
      `;
    }
  </script>
</body>
</html>
